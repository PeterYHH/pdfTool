<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>PDF 分割</title>
  <!-- 引入 pdf-lib -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f2f2f2;
      padding: 20px;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      color: #333;
    }
    /* 將 label 寬度從 180px 調整為 250px */
    label {
      display: inline-block;
      width: 250px;
      margin-bottom: 10px;
      font-weight: bold;
    }
    input[type="number"],
    input[type="file"] {
      width: calc(100% - 260px);
      padding: 5px;
      margin-bottom: 10px;
    }
    button {
      display: block;
      width: 100%;
      background: #007bff;
      color: #fff;
      border: none;
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover {
      background: #0056b3;
    }
    .btn {
      display: inline-block;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 0;
      transition: background 0.3s ease;
      text-decoration: none;
    }
    .btn:hover {
      background: #0056b3;
    }
    .note {
      font-size: 14px;
      color: #555;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 回主頁按鈕 -->
    <div style="text-align: right; margin-bottom: 10px;">
      <a href="../index.html" class="btn">回主頁</a>
    </div>
    <h2>PDF 分割</h2>
    <!-- 上傳 PDF 檔案 -->
    <div>
      <label for="pdfFile">選擇 PDF：</label>
      <input type="file" id="pdfFile" accept="application/pdf">
    </div>
    <!-- 輸入分割範圍 -->
    <div>
      <label for="startPage">起始頁（從 1 開始）：</label>
      <input type="number" id="startPage" value="1" min="1">
    </div>
    <div>
      <label for="endPage">結束頁（包含設定頁數）：</label>
      <input type="number" id="endPage" value="1" min="1">
    </div>
    <!-- PDF 元資料設定 -->
    <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px;">
      <h3 style="margin-top: 0; color: #333; font-size: 18px;">PDF 元資料設定（選填）</h3>
      <div style="margin-bottom: 10px;">
        <label for="pdfTitle" style="display: inline-block; width: 250px; margin-bottom: 5px; font-weight: bold;">標題：</label>
        <input type="text" id="pdfTitle" placeholder="請輸入 PDF 標題" style="width: calc(100% - 260px); padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
      </div>
      <div style="margin-bottom: 10px;">
        <label for="pdfAuthor" style="display: inline-block; width: 250px; margin-bottom: 5px; font-weight: bold;">作者：</label>
        <input type="text" id="pdfAuthor" placeholder="請輸入作者名稱" style="width: calc(100% - 260px); padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
      </div>
      <div style="margin-bottom: 10px;">
        <label for="pdfSubject" style="display: inline-block; width: 250px; margin-bottom: 5px; font-weight: bold;">主題：</label>
        <input type="text" id="pdfSubject" placeholder="請輸入文件主題" style="width: calc(100% - 260px); padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
      </div>
      <div style="margin-bottom: 10px;">
        <label for="pdfCreator" style="display: inline-block; width: 250px; margin-bottom: 5px; font-weight: bold;">建立者：</label>
        <input type="text" id="pdfCreator" placeholder="請輸入建立者資訊" style="width: calc(100% - 260px); padding: 5px; border: 1px solid #ddd; border-radius: 3px;">
      </div>
    </div>
    <!-- 檔名設定 -->
    <div>
      <label for="outputFileName">輸出檔名（選填）：</label>
      <input type="text" id="outputFileName" placeholder="若未填寫，將使用時間戳記命名" style="width: calc(100% - 260px); padding: 5px;">
      <div class="note" style="margin-top: 5px; margin-bottom: 10px;">
        ※ 不需要輸入 .pdf 副檔名
      </div>
    </div>
    <button id="splitBtn">分割 PDF</button>
    <div class="note">
      ※ 範例說明：若輸入起始頁 1 與結束頁 3，則將包含第 1、2、3 頁。
    </div>
  </div>

  <script>
    const { PDFDocument } = PDFLib;

    // 產生時間戳記檔名的函數
    function generateTimestampFilename() {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      return `${year}${month}${day}${hours}${minutes}${seconds}.pdf`;
    }

    // 當起始頁變動時，自動設定結束頁的最小值與數值
    document.getElementById('startPage').addEventListener('change', function() {
      let startVal = parseInt(this.value, 10) || 1;
      // 若起始頁改變，將結束頁的最小值設為起始頁
      let endInput = document.getElementById('endPage');
      endInput.min = startVal;
      // 如果目前結束頁的值小於起始頁，則自動更新為起始頁
      if (parseInt(endInput.value, 10) < startVal) {
        endInput.value = startVal;
      }
    });

    document.getElementById('splitBtn').addEventListener('click', async () => {
      const fileInput = document.getElementById('pdfFile');
      if (!fileInput.files.length) {
        alert("請先選擇一個 PDF 檔案");
        return;
      }
      
      // 取得使用者輸入的起始與結束頁（均為 1-based）
      const userStartPage = parseInt(document.getElementById('startPage').value, 10);
      const userEndPage   = parseInt(document.getElementById('endPage').value, 10);

      // 檢查輸入有效性
      if (isNaN(userStartPage) || isNaN(userEndPage) || userStartPage < 1 || userEndPage < userStartPage) {
        alert("請確認輸入的頁碼有效且結束頁不小於起始頁");
        return;
      }

      // 讀取 PDF 檔案內容
      const arrayBuffer = await fileInput.files[0].arrayBuffer();
      // 使用 ignoreEncryption 選項以避免加密 PDF 拋錯
      const pdfDoc = await PDFDocument.load(arrayBuffer, { ignoreEncryption: true });
      const totalPages = pdfDoc.getPageCount();
      
      // 使用者輸入為 1-based，轉換為 0-based
      const startIndex = userStartPage - 1;
      const endIndex = userEndPage - 1; // 結束頁包含設定頁數
      
      if (startIndex >= totalPages || endIndex >= totalPages) {
        alert("輸入的頁碼超出 PDF 總頁數（總頁數：" + totalPages + "）");
        return;
      }
      
      // 建立一個新的 PDF 用以存放指定頁面
      const newPdf = await PDFDocument.create();
      const pageIndices = [];
      // 從 startIndex 到 endIndex（包含 endIndex）
      for (let i = startIndex; i <= endIndex; i++) {
        pageIndices.push(i);
      }
      
      // 複製指定頁面至新 PDF
      const copiedPages = await newPdf.copyPages(pdfDoc, pageIndices);
      copiedPages.forEach(page => newPdf.addPage(page));
      
      // 設定 PDF 元資料
      const title = document.getElementById('pdfTitle').value.trim();
      const author = document.getElementById('pdfAuthor').value.trim();
      const subject = document.getElementById('pdfSubject').value.trim();
      const creator = document.getElementById('pdfCreator').value.trim();
      
      if (title) newPdf.setTitle(title);
      if (author) newPdf.setAuthor(author);
      if (subject) newPdf.setSubject(subject);
      if (creator) newPdf.setCreator(creator);
      newPdf.setProducer('');
      newPdf.setCreationDate(new Date());
      newPdf.setModificationDate(new Date());
      
      // 儲存新的 PDF 並觸發下載
      const pdfBytes = await newPdf.save();
      const blob = new Blob([pdfBytes], { type: 'application/pdf' });
      const url = URL.createObjectURL(blob);
      
      // 取得使用者輸入的檔名，如果沒有則使用時間戳記
      const customFileName = document.getElementById('outputFileName').value.trim();
      const fileName = customFileName ? `${customFileName}.pdf` : generateTimestampFilename();
      
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
